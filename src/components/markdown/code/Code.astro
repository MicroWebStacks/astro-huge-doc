---
import Highlighter from './Highlighter.astro'
import ModelViewerCode from '../model/ModelViewerCode.astro';
import Cards from '../cards/Cards.astro'
import Gallery from '../../gallery/gallery.astro';
import kroki from './kroki.yaml'
import { getAssetWithBlob } from '@/libs/structure-db';
import DiagramCode from './DiagramCode.astro';

export interface Props {
    item: {
        asset_uid: string;
        ast:{
            model?: object;
            gallery?: object;
        }
    }
}

const { item } = Astro.props as Props;
const {asset, buffer} = getAssetWithBlob(item.asset_uid)
const code = new TextDecoder().decode(buffer)
let language = asset.ext ?? 'text'
const krokiLanguage = asset.ext ? kroki.formats[asset.ext] : undefined
if(asset.type == "linked_file" && krokiLanguage){
    console.log("Kroki format detected for extension:", asset.ext)
    language = krokiLanguage
}
const params = asset.params?asset.params.split(' '):[]
const asset_uid = item.asset_uid

const yaml_glb      = ((language == "yaml") && (asset.params?.startsWith("glb")))
const yaml_cards    = ((language == "yaml") && (asset.params?.startsWith("cards")))
const yaml_gallery  = ((language == "yaml") && (asset.params?.startsWith("gallery")))

const is_diagram = kroki.languages.includes(language)
const custom_yaml = yaml_glb || yaml_cards || yaml_gallery
const other_language = (!is_diagram && !custom_yaml)

---
{(is_diagram)&&
    <DiagramCode uid={asset_uid} code={code} language={language} params={params} meta={asset.params} />
}
{yaml_glb &&
    <ModelViewerCode uid={asset_uid} code={code} model={item.ast.model}/>
}
{yaml_cards &&
    <Cards code={code} />
}
{yaml_gallery &&
    <Gallery model={item.ast.gallery} />
}
{other_language&&
    <Highlighter uid={item.asset_uid} code={code} language={language} params={params} />
}
