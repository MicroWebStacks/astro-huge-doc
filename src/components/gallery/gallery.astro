---
import {calculate_span,select_masonry} from './grid_utils.js'
import {getAssetBlob, getImageInfo} from '../../libs/structure-db.js';
import { config } from '@/config';

interface GalleryItem {
    uid: string;
}

export interface Props {
    model: GalleryItem[];
    masonry: boolean;
}

const { model, masonry=null } = Astro.props as Props;
const images_uids = model.map((item)=>(item.uid));
const imagesInfo = images_uids.map((uid)=>{
    const info = getImageInfo(uid);
    const blob_uid = getAssetBlob(uid, config.collect.version_id);
    return {
        url: `/assets/${blob_uid}:${uid}`,
        ...info,
        ...calculate_span(info.ratio)
    }
});

let mas = masonry
if(mas == null){
    mas = select_masonry(imagesInfo)
}

---

<div class={`pswp-gallery container ${mas?'masonry':'grid'}`} id="my-gallery">
    {imagesInfo.map((image)=>(
        <a  href={image.url}
            class={`item  ${mas?'masonry':'grid'}`}
            style={`grid-area: span ${image.spanHeight} / span ${image.spanWidth};`}
            itemscope
            itemtype="http://schema.org/ImageGallery"
            data-pswp-width={image.width} 
            data-pswp-height={image.height} >
                <img src={image.url} />
        </a>
    ))}
</div>

<style>
.container.grid{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(10rem, 1fr));
    grid-auto-rows: 10rem;
    grid-gap: 10px;
}
img{
    width: 100%;
    height: 100%;
    object-fit:cover;
}
.container.masonry{
    column-width: 20rem;
    column-gap: 1rem;
}
.item.masonry{
    break-inside: avoid;
    margin-bottom: 1rem;
}
</style>

<script src="./gallery.js" />
